#!/bin/bash

# fail fast on errors
set -e

indent() {
  sed "s/^/       /"
}

puts-step() {
  echo "-----> $@"
}


BUILD_DIR=$1
CACHE_DIR=$2
export ENV_DIR=$3

BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)

TMP_DIR=$(mktemp -d)
APP_DIR=$TMP_DIR/app
KEY_PROVIDER=${KEY_PROVIDER:=$(cat ${ENV_DIR}/KEY_PROVIDER)}

mkdir ${APP_DIR}
shopt -s dotglob nullglob
puts-step "Creating inner slug"
mv ${BUILD_DIR}/* ${APP_DIR}/
tar -C ${TMP_DIR} -czf ${TMP_DIR}/slug.tgz ./app

puts-step "Encrypting inner slug with ${KEY_PROVIDER} provider"
PASSPHRASE=$(${ROOT_DIR}/lib/providers/${KEY_PROVIDER} encrypting ${BUILD_DIR}/encr_key)
gpg --output ${BUILD_DIR}/slug.tgz.gpg --cipher-algo AES256 --quiet --symmetric --batch --no-tty --passphrase="${PASSPHRASE}" --no-use-agent $TMP_DIR/slug.tgz |& indent

puts-step "Creating outer slug"
cp -a ${ROOT_DIR}/lib ${BUILD_DIR}/
cat ${APP_DIR}/Procfile | awk -F ':' '{print $1": ./lib/decrypt_and_run.sh "$1}' > ${BUILD_DIR}/Procfile
