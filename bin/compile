#!/bin/bash

# fail fast on errors
set -e

BUILD_DIR=$1
CACHE_DIR=$2
export ENV_DIR=$3

BIN_DIR=$(cd $(dirname $0); pwd)
ROOT_DIR=$(dirname $BIN_DIR)

TMP_DIR=$(mktemp -d)
APP_DIR=$TMP_DIR/app
KEY_PROVIDER=${KEY_PROVIDER:=$(cat ${ENV_DIR}/KEY_PROVIDER)}

mkdir ${APP_DIR}
shopt -s dotglob nullglob
mv ${BUILD_DIR}/* ${APP_DIR}/
tar -C ${TMP_DIR} -czf ${TMP_DIR}/slug.tgz ./app

PASSPHRASE=$(${ROOT_DIR}/lib/providers/${KEY_PROVIDER} encrypting ${BUILD_DIR}/encr_key)
gpg --output ${BUILD_DIR}/slug.tgz.gpg --symmetric --batch --no-tty --passphrase="${PASSPHRASE}" --no-use-agent $TMP_DIR/slug.tgz

cp -a ${ROOT_DIR}/lib/decrypt_and_run.sh ${BUILD_DIR}/
cp -a ${ROOT_DIR}/lib ${BUILD_DIR}/
cp ${TMP_DIR}/app/passphrase ${BUILD_DIR}/
cat ${APP_DIR}/Procfile | awk -F ':' '{print $1": ./decrypt_and_run.sh "$1}' > ${BUILD_DIR}/Procfile
